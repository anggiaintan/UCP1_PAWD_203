<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Pasien</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Manajemen Data Pasien</h1>

        <!-- Tampilkan Daftar Pasien -->
        <h3>Daftar Pasien</h3>
        <table class="table table-bordered" id="pasien-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nama</th>
                    <th>Usia</th>
                    <th>Diagnosis</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                <% if (pasien.length > 0) { %>
                    <% pasien.forEach(p => { %>
                        <tr data-id="<%= p.id %>">
                            <td><%= p.id %></td>
                            <td><%= p.nama %></td>
                            <td><%= p.usia %></td>
                            <td><%= p.diagnosis %></td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick="editPasien('<%= p.id %>', '<%= p.nama %>', '<%= p.usia %>', '<%= p.diagnosis %>')">Edit</button>
                                <form action="/pasien/delete" method="POST" style="display: inline;">
                                    <input type="hidden" name="id" value="<%= p.id %>">
                                    <button type="submit" class="btn btn-danger btn-sm">Hapus</button>
                                </form>
                            </td>
                        </tr>
                    <% }) %>
                <% } else { %>
                    <tr>
                        <td colspan="5" class="text-center">Tidak ada data pasien.</td>
                    </tr>
                <% } %>
            </tbody>
        </table>

        <!-- Form untuk Tambah Pasien -->
        <h3 id="form-title">Tambah Pasien</h3>
        <form id="form-pasien-add" action="/pasien" method="POST">
            <div class="mb-3">
                <label for="nama" class="form-label">Nama Pasien</label>
                <input type="text" class="form-control" id="nama" name="nama" required>
            </div>
            <div class="mb-3">
                <label for="usia" class="form-label">Usia</label>
                <input type="number" class="form-control" id="usia" name="usia" required>
            </div>
            <div class="mb-3">
                <label for="diagnosis" class="form-label">Diagnosis</label>
                <textarea class="form-control" id="diagnosis" name="diagnosis" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Tambah</button>
        </form>

        <!-- Form untuk Update Pasien -->
        <h3 id="form-title-edit" style="display:none;">Update Pasien</h3>
        <form id="form-pasien-edit" action="/pasien/update" method="POST" style="display:none;">
            <input type="hidden" id="pasien-id" name="id">
            <div class="mb-3">
                <label for="nama-edit" class="form-label">Nama Pasien</label>
                <input type="text" class="form-control" id="nama-edit" name="nama" required>
            </div>
            <div class="mb-3">
                <label for="usia-edit" class="form-label">Usia</label>
                <input type="number" class="form-control" id="usia-edit" name="usia" required>
            </div>
            <div class="mb-3">
                <label for="diagnosis-edit" class="form-label">Diagnosis</label>
                <textarea class="form-control" id="diagnosis-edit" name="diagnosis" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Update</button>
        </form>             
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Menangani pengiriman form tambah pasien menggunakan AJAX
        $('#form-pasien-add').submit(function (e) {
            e.preventDefault();

            const nama = $('#nama').val();
            const usia = $('#usia').val();
            const diagnosis = $('#diagnosis').val();

            $.ajax({
                type: 'POST',
                url: '/pasien',
                data: { nama, usia, diagnosis },
                success: function (data) {
                    $('#nama').val('');
                    $('#usia').val('');
                    $('#diagnosis').val('');
                    $('#pasien-table tbody').append(`
                        <tr data-id="${data.id}">
                            <td>${data.id}</td>
                            <td>${data.nama}</td>
                            <td>${data.usia}</td>
                            <td>${data.diagnosis}</td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick="editPasien('${data.id}', '${data.nama}', '${data.usia}', '${data.diagnosis}')">Edit</button>
                                <form action="/pasien/delete" method="POST" style="display: inline;">
                                    <input type="hidden" name="id" value="${data.id}">
                                    <button type="submit" class="btn btn-danger btn-sm">Hapus</button>
                                </form>
                            </td>
                        </tr>
                    `);
                },
                error: function (xhr, status, error) {
                    alert('Error adding patient: ' + (xhr.responseJSON?.error || error));
                }
            });
        });

        // Fungsi untuk mengisi data ke form edit pasien dan menampilkan form tersebut
        function editPasien(id, nama, usia, diagnosis) {
            $('#pasien-id').val(id);
            $('#nama-edit').val(nama);
            $('#usia-edit').val(usia);
            $('#diagnosis-edit').val(diagnosis);

            $('#form-pasien-add').hide();  // Sembunyikan form tambah pasien
            $('#form-pasien-edit').show(); // Tampilkan form edit pasien
            $('#form-title').hide();       // Sembunyikan judul form tambah
            $('#form-title-edit').show();  // Tampilkan judul form edit
        }

        // Fungsi untuk menangani pengiriman form update pasien menggunakan AJAX (PUT)
        $('#form-pasien-edit').submit(function (e) {
            e.preventDefault();  // Prevent default form submission

            // Ambil data form
            const id = $('#pasien-id').val();
            const nama = $('#nama-edit').val();
            const usia = $('#usia-edit').val();
            const diagnosis = $('#diagnosis-edit').val();

            // Kirim data menggunakan AJAX dengan method PUT
            $.ajax({
                type: 'PUT',
                url: '/pasien/update', // Endpoint untuk update data pasien
                data: { id, nama, usia, diagnosis },
                success: function (data) {
                    // Update the table row with the new data
                    const row = $(`#pasien-table tr[data-id=${data.id}]`);
                    row.find('td:nth-child(2)').text(data.nama);
                    row.find('td:nth-child(3)').text(data.usia);
                    row.find('td:nth-child(4)').text(data.diagnosis);

                    // Reset the form dan tampilkan form tambah lagi
                    resetForm();
                },
                error: function (error) {
                    alert('Error updating patient');
                }
            });
        });

        // Fungsi untuk mereset form setelah update atau tambah
        function resetForm() {
            $('#form-pasien-add').show();
            $('#form-pasien-edit').hide();
            $('#form-title').show();
            $('#form-title-edit').hide();
            $('#nama-edit').val('');
            $('#usia-edit').val('');
            $('#diagnosis-edit').val('');
        }
    </script>
</body>
</html>
